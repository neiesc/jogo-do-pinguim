name: Build Godot C# Project for Web

on:
  push:
    branches: [ main, master ]
  pull_request:

env:
  GODOT_VERSION: '3.6.2-stable'
  EXPORT_NAME: MeuJogo
  PROJECT_PATH: '.'

jobs:
  export_game:
    runs-on: ubuntu-latest
    name: Export Game
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # CORREÇÃO AQUI: Uso de wildcards para garantir que encontramos os arquivos
      - name: Install Godot Mono
        run: |
          echo "Baixando Godot ${{ env.GODOT_VERSION }} Mono..."
          wget -q https://github.com/godotengine/godot/releases/download/${{ env.GODOT_VERSION }}/Godot_v${{ env.GODOT_VERSION }}_mono_linux_headless_64.zip
          
          echo "Extraindo..."
          unzip -q Godot_v${{ env.GODOT_VERSION }}_mono_linux_headless_64.zip
          
          echo "Renomeando pasta extraída..."
          # Move a pasta extraída (qualquer que seja o nome dela) para 'godot_bin_dir'
          mv Godot_v*mono_linux_headless_64 godot_bin_dir
          
          echo "Configurando permissões..."
          # Dá permissão de execução para o binário dentro da pasta (qualquer arquivo começando com Godot_v)
          chmod +x godot_bin_dir/Godot_v*
          
          echo "Criando link simbólico..."
          # Cria um link chamado 'godot' apontando para o binário real
          # O comando find garante que pegamos apenas o arquivo, não a pasta GodotSharp
          GODOT_BINARY=$(find godot_bin_dir -maxdepth 1 -type f -name "Godot_v*")
          ln -s $GITHUB_WORKSPACE/$GODOT_BINARY $GITHUB_WORKSPACE/godot_bin_dir/godot
          
          echo "Adicionando ao PATH..."
          echo "$GITHUB_WORKSPACE/godot_bin_dir" >> $GITHUB_PATH

      - name: Verify Godot Installation
        run: |
          godot --version

      - name: Install Export Templates
        run: |
          wget -q https://github.com/godotengine/godot/releases/download/${{ env.GODOT_VERSION }}/Godot_v${{ env.GODOT_VERSION }}_mono_export_templates.tpz
          mkdir -p ~/.local/share/godot/export_templates/${{ env.GODOT_VERSION }}.mono
          unzip -q Godot_v${{ env.GODOT_VERSION }}_mono_export_templates.tpz
          mv templates/* ~/.local/share/godot/export_templates/${{ env.GODOT_VERSION }}.mono/
          rm -f Godot_v${{ env.GODOT_VERSION }}_mono_export_templates.tpz

      - name: Dotnet Restore
        run: dotnet restore ${{ env.PROJECT_PATH }}

      - name: Create Build Directories
        run: |
          mkdir -p build/windows
          mkdir -p build/linux

      - name: Export to Web
        run: |
          godot --headless --path "${{ env.PROJECT_PATH }}" --export-release "Web" "build/web/index.html"

      - name: Upload Web Build
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web